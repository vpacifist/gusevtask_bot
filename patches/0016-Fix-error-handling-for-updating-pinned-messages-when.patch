From 0f7bf431d77d0d0b2732ecbd903af49cfef4721b Mon Sep 17 00:00:00 2001
From: vovagusev <v@vovagusev.ru>
Date: Thu, 30 May 2024 22:39:25 +0400
Subject: [PATCH 16/28] Fix error handling for updating pinned messages when
 the message is not found

---
 mybot/bot.py | 33 +++++++++++++++++++--------------
 1 file changed, 19 insertions(+), 14 deletions(-)

diff --git a/mybot/bot.py b/mybot/bot.py
index 335b769..8da745d 100644
--- a/mybot/bot.py
+++ b/mybot/bot.py
@@ -461,6 +461,10 @@ async def update_pinned_message(chat_id: int, bot) -> None:
                     parse_mode=ParseMode.HTML
                 )
             else:
+                raise BadRequest("Pinned message not found")
+        except (TelegramError, BadRequest) as e:
+            logging.error(f"Error updating pinned message: {e}")
+            try:
                 logging.info("Sending new pinned message")
                 sent_message = await bot.send_message(
                     chat_id=chat_id,
@@ -472,19 +476,19 @@ async def update_pinned_message(chat_id: int, bot) -> None:
                     chat_id=chat_id,
                     message_id=sent_message.message_id
                 )
-        except TelegramError as e:
-            logging.error(f"Error updating pinned message: {e}")
-            if isinstance(e, (BadRequest, Forbidden)):
-                await bot.send_message(
-                    chat_id=chat_id,
-                    text="âš ï¸ Ð£ Ð¼ÐµÐ½Ñ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ Ð·Ð°ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹. "
-                         "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐ´ÐµÐ»Ð°Ð¹Ñ‚Ðµ Ð¼ÐµÐ½Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ Ð¸ Ð´Ð°Ð¹Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¾ Ð·Ð°ÐºÑ€ÐµÐ¿Ð»ÑÑ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ. ðŸ™"
-                )
-            else:
-                await bot.send_message(
-                    chat_id=chat_id,
-                    text="ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÐ¿Ð¸ÑÐºÐ° Ð·Ð°Ð´Ð°Ñ‡. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ."
-                )
+            except TelegramError as e:
+                logging.error(f"Error sending new pinned message: {e}")
+                if isinstance(e, (BadRequest, Forbidden)):
+                    await bot.send_message(
+                        chat_id=chat_id,
+                        text="âš ï¸ Ð£ Ð¼ÐµÐ½Ñ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ Ð·Ð°ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹. "
+                             "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐ´ÐµÐ»Ð°Ð¹Ñ‚Ðµ Ð¼ÐµÐ½Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ Ð¸ Ð´Ð°Ð¹Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¾ Ð·Ð°ÐºÑ€ÐµÐ¿Ð»ÑÑ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ. ðŸ™"
+                    )
+                else:
+                    await bot.send_message(
+                        chat_id=chat_id,
+                        text="ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÐ¿Ð¸ÑÐºÐ° Ð·Ð°Ð´Ð°Ñ‡. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ."
+                    )
 
         if not tasks and chat_id in pinned_message_id:
             try:
@@ -494,7 +498,8 @@ async def update_pinned_message(chat_id: int, bot) -> None:
                     message_id=pinned_message_id[chat_id],
                     text="ÐÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‡."
                 )
-            except (BadRequest, Forbidden) as e:logging.error(f"Failed to edit pinned message: {e}")
+            except (BadRequest, Forbidden) as e:
+                logging.error(f"Failed to edit pinned message: {e}")
 
 
 async def help_command(update: Update, _context: CallbackContext) -> None:
-- 
2.45.1.windows.1

